name: react-iam
on:
  push:
    branches:
      - production

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      - name: Build Docker image
        run: docker build -t my-react-app .
      - name: Start Docker container
        run: docker run -d -p 3000:3000 --name my-react-app my-react-app
      - name: Configure Nginx
        run: |
          sudo nginx -s stop
          sudo tee /etc/nginx/sites-available/my-react-app <<EOF
          server {
            listen 80;
            server_name sree.cloud.pathi;

            location / {
              proxy_pass http://localhost:3000;
              proxy_http_version 1.1;
              proxy_set_header Upgrade \$http_upgrade;
              proxy_set_header Connection 'upgrade';
              proxy_set_header Host \$host;
              proxy_cache_bypass \$http_upgrade;
            }
          }
          EOF
          sudo ln -s /etc/nginx/sites-available/my-react-app /etc/nginx/sites-enabled/
          sudo nginx -s reload
